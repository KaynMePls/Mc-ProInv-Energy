{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <!-- Título principal -->
    <div class="d-flex justify-content-between align-items-center mb-4">
    <img src="{{ url_for('static', filename='Solarium.png') }}" alt="Logo Empresa" style="height:150px; width:auto; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
        <h2 class="fw-bold text-primary">
            <i class="bi bi-bar-chart-fill me-2" style="color:#c10606"></i>Dashboard Contable
        </h2>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger rounded-pill px-4 py-2">
            <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
        </a>
    </div>

    <!-- Filtros avanzados -->
    <form method="get" class="row g-3 align-items-end mb-4 bg-light rounded-4 p-3 shadow-sm">
        <div class="col-md-2">
            <label for="mes" class="form-label fw-semibold">Mes</label>
            <select name="mes" id="mes" class="form-select rounded-pill">
                <option value="">Todos</option>
                {% for i in range(1, 13) %}
                <option value="{{ i }}" {% if request.args.get('mes', '') == i|string %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="anio" class="form-label fw-semibold">Año</label>
            <select name="anio" id="anio" class="form-select rounded-pill">
                <option value="">Todos</option>
                {% for y in range(2023, now.year+1) %}
                <option value="{{ y }}" {% if request.args.get('anio', '') == y|string %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="categoria" class="form-label fw-semibold">Categoría</label>
            <select name="categoria" id="categoria" class="form-select rounded-pill">
                <option value="">Todas</option>
                {% for c in categorias %}
                <option value="{{ c }}" {% if request.args.get('categoria', '') == c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="buscar" class="form-label fw-semibold">Buscar</label>
            <input type="text" name="buscar" id="buscar" class="form-control rounded-pill" placeholder="Descripción, monto...">
        </div>
        <div class="col-md-2 text-end">
            <button type="submit" class="btn btn-primary rounded-pill px-4">
                <i class="bi bi-funnel-fill me-1"></i>Filtrar
            </button>
        </div>
    </form>

    <!-- Tarjetas resumen financiero -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 bg-gradient bg-success-subtle text-success h-100">
                <div class="card-body text-center">
                    <i class="bi bi-arrow-down-circle fs-1"></i>
                    <h6 class="fw-bold mt-2">Ingresos</h6>
                    <h3 class="fw-bold">${{ '{:,}'.format(total_ingresos|int) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 bg-gradient bg-danger-subtle text-danger h-100">
                <div class="card-body text-center">
                    <i class="bi bi-arrow-up-circle fs-1"></i>
                    <h6 class="fw-bold mt-2">Egresos</h6>
                    <h3 class="fw-bold">${{ '{:,}'.format(total_egresos|int) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 bg-gradient {% if balance_neto >= 0 %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %} h-100">
                <div class="card-body text-center">
                    <i class="bi bi-calculator fs-1"></i>
                    <h6 class="fw-bold mt-2">Balance Neto</h6>
                    <h3 class="fw-bold">${{ '{:,}'.format(balance_neto|int) }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-0 fw-bold">
                    <i class="bi bi-graph-up-arrow me-2"></i>Evolución Mensual
                </div>
                <div class="card-body">
                    <canvas id="evolucionChart" height="120"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-0 fw-bold">
                    <i class="bi bi-pie-chart-fill me-2"></i>Distribución de Egresos
                </div>
                <div class="card-body">
                    <canvas id="egresosPieChart" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Últimas transacciones -->
    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-header bg-white border-0 fw-bold">
            <i class="bi bi-clock-history me-2"></i>Últimas Transacciones
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead style="background: linear-gradient(90deg,#e9ecef,#f8f9fa);">
                        <tr>
                            <th class="text-center">Fecha</th>
                            <th class="text-center">Tipo</th>
                            <th class="text-center">Monto</th>
                            <th class="text-center">Categoría</th>
                            <th class="text-center">Descripción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in ultimas_transacciones %}
                        <tr class="{% if loop.index0 % 2 == 0 %}table-light{% endif %}">
                            <td class="text-center">{{ t.fecha.strftime('%Y-%m-%d') }}</td>
                            <td class="text-center">
                                <span class="badge px-3 py-2 {% if t.tipo == 'ingreso' %}bg-success{% else %}bg-danger{% endif %} text-white rounded-pill shadow">{{ t.tipo|capitalize }}</span>
                            </td>
                            <td class="text-center fw-bold">${{ '{:,}'.format(t.monto|int) }}</td>
                            <td class="text-center">
                                <span class="badge bg-info text-dark rounded-pill px-3 py-2 shadow">{{ t.categoria }}</span>
                            </td>
                            <td class="text-center">
                                <span title="{{ t.descripcion }}">{{ t.descripcion[:40] }}{% if t.descripcion|length > 40 %}...{% endif %}</span>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No hay transacciones recientes.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Accesos rápidos -->
    <div class="d-flex flex-wrap gap-2 justify-content-end mb-4">
        <a href="{{ url_for('contabilidad.nueva_transaccion') }}" class="btn btn-primary rounded-pill px-4 fw-semibold">
            <i class="bi bi-plus-circle me-2"></i>Registrar Transacción
        </a>
        <a href="{{ url_for('contabilidad.transacciones') }}" class="btn btn-secondary rounded-pill px-4 fw-semibold">
            <i class="bi bi-table me-2"></i>Ver Todas
        </a>
        <a href="{{ url_for('contabilidad.reporte') }}" class="btn btn-success rounded-pill px-4 fw-semibold">
            <i class="bi bi-file-earmark-excel me-2"></i>Generar Reporte
        </a>
        <a href="{{ url_for('contabilidad.nueva_compra') }}" class="btn btn-warning rounded-pill px-4 fw-semibold">
            <i class="bi bi-cart-plus me-2"></i>Comprar a Proveedores
        </a>
        <a href="{{ url_for('contabilidad.compras') }}" class="btn btn-info rounded-pill fw-semibold">
    <i class="bi bi-receipt me-2"></i>Ver Órdenes de Compra
</a>
    </div>
</div>

<!-- Gráficos JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var labelsMeses = {{ labels_meses|tojson }};
    var datosIngresos = {{ datos_ingresos|tojson }};
    var datosEgresos = {{ datos_egresos|tojson }};
    var labelsEgresos = {{ labels_egresos|tojson }};
    var datosEgresosCategoria = {{ datos_egresos_categoria|tojson }};

    // Evolución mensual
    var ctx = document.getElementById('evolucionChart').getContext('2d');
    var evolucionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labelsMeses,
            datasets: [{
                label: 'Ingresos',
                data: datosIngresos,
                borderColor: '#198754',
                backgroundColor: 'rgba(25,135,84,0.2)',
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: '#198754',
                fill: true
            }, {
                label: 'Egresos',
                data: datosEgresos,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220,53,69,0.2)',
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: '#dc3545',
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Pie egresos por categoría
    var ctxPie = document.getElementById('egresosPieChart').getContext('2d');
    var egresosPieChart = new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: labelsEgresos,
            datasets: [{
                data: datosEgresosCategoria,
                backgroundColor: [
                    '#dc3545', '#ffc107', '#0d6efd', '#198754', '#6f42c1', '#fd7e14'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
</script>
{% endblock %}...
<!-- Tarjetas resumen financiero -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm rounded-4 bg-success-subtle h-100">
            <div class="card-body text-center">
                <i class="bi bi-arrow-down-circle fs-1 text-success"></i>
                <h6 class="fw-bold mt-2 text-success">Ingresos</h6>
                <h3 class="fw-bold text-success">${{ '{:,}'.format(total_ingresos|int) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm rounded-4 bg-danger-subtle h-100">
            <div class="card-body text-center">
                <i class="bi bi-arrow-up-circle fs-1 text-danger"></i>
                <h6 class="fw-bold mt-2 text-danger">Egresos</h6>
                <h3 class="fw-bold text-danger">${{ '{:,}'.format(total_egresos|int) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm rounded-4 {% if balance_neto >= 0 %}bg-primary-subtle{% else %}bg-warning-subtle{% endif %} h-100">
            <div class="card-body text-center">
                <i class="bi bi-calculator fs-1 {% if balance_neto >= 0 %}text-primary{% else %}text-warning{% endif %}"></i>
                <h6 class="fw-bold mt-2 {% if balance_neto >= 0 %}text-primary{% else %}text-warning{% endif %}">Balance Neto</h6>
                <h3 class="fw-bold {% if balance_neto >= 0 %}text-primary{% else %}text-warning{% endif %}">${{ '{:,}'.format(balance_neto|int) }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-header bg-white border-0 fw-bold text-primary">
                <i class="bi bi-graph-up-arrow me-2"></i>Evolución Mensual
            </div>
            <div class="card-body">
                <canvas id="evolucionChart" height="120"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-header bg-white border-0 fw-bold text-danger">
                <i class="bi bi-pie-chart-fill me-2"></i>Distribución de Egresos
            </div>
            <div class="card-body">
                <canvas id="egresosPieChart" height="120"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Últimas transacciones -->
<div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-header bg-white border-0 fw-bold text-info">
        <i class="bi bi-clock-history me-2"></i>Últimas Transacciones
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-primary">
                    <tr>
                        <th class="text-center text-primary">Fecha</th>
                        <th class="text-center text-primary">Tipo</th>
                        <th class="text-center text-primary">Monto</th>
                        <th class="text-center text-primary">Categoría</th>
                        <th class="text-center text-primary">Descripción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in ultimas_transacciones %}
                    <tr>
                        <td class="text-center">{{ t.fecha.strftime('%Y-%m-%d') }}</td>
                        <td class="text-center">
                            <span class="badge px-3 py-2 {% if t.tipo == 'ingreso' %}bg-success text-white{% else %}bg-danger text-white{% endif %} rounded-pill">{{ t.tipo|capitalize }}</span>
                        </td>
                        <td class="text-center fw-bold text-dark">${{ '{:,}'.format(t.monto|int) }}</td>
                        <td class="text-center">
                            <span class="badge bg-info text-dark rounded-pill px-3 py-2">{{ t.categoria }}</span>
                        </td>
                        <td class="text-center">
                            <span title="{{ t.descripcion }}">{{ t.descripcion[:40] }}{% if t.descripcion|length > 40 %}...{% endif %}</span>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No hay transacciones recientes.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Gráficos JS -->
<script>
    var labelsMeses = {{ labels_meses|tojson }};
    var datosIngresos = {{ datos_ingresos|tojson }};
    var datosEgresos = {{ datos_egresos|tojson }};
    var labelsEgresos = {{ labels_egresos|tojson }};
    var datosEgresosCategoria = {{ datos_egresos_categoria|tojson }};

    // Evolución mensual
    var ctx = document.getElementById('evolucionChart').getContext('2d');
    var evolucionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labelsMeses,
            datasets: [{
                label: 'Ingresos',
                data: datosIngresos,
                borderColor: '#198754',
                backgroundColor: 'rgba(25,135,84,0.2)',
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: '#198754',
                fill: true
            }, {
                label: 'Egresos',
                data: datosEgresos,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220,53,69,0.2)',
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: '#dc3545',
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top', labels: { color: '#212529', font: { size: 14 } } }
            },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#212529' } },
                x: { ticks: { color: '#212529' } }
            }
        }
    });

    // Pie egresos por categoría
    var ctxPie = document.getElementById('egresosPieChart').getContext('2d');
    var egresosPieChart = new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: labelsEgresos,
            datasets: [{
                data: datosEgresosCategoria,
                backgroundColor: [
                    '#dc3545', '#ffc107', '#0d6efd', '#198754', '#6f42c1', '#fd7e14'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#212529', font: { size: 13 } } }
            }
        }
    });
</script>
...